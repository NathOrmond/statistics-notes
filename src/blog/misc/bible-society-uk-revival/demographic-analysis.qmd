---
title: "Demographic Analysis"
subtitle: "Population composition changes and their impact"
execute:
  echo: true
  warning: false
  message: false
---

```{r}
#| label: setup
#| include: false

# Set working directory to project root using here package
if (!require(here, quietly = TRUE)) {
  install.packages("here")
}
# Find project root (directory containing _quarto.yml)
here::i_am("_quarto.yml")
# Set working directory to project root
setwd(here())

library(tidyverse)
library(scales)
library(ggplot2)
```

## Introduction

Between 2018 and 2024, the UK population composition changed significantly due to immigration, particularly:

- **Ukrainian refugees**: ~217,000-255,000 (post-February 2022)
- **Hong Kong BN(O) visa holders**: >163,000 (January 2021 - March 2025)
- Other net migration changes

These groups may have different religious attendance patterns than the existing UK population, which could explain apparent changes in church attendance.

## Attendance by Ethnicity (2024)

```{r}
#| label: ethnicity-breakdown

attendance_data <- read_csv(here::here("data/bible-society-uk-revival/processed/church-attendance-extracted.csv"))

# Extract 2024 attendance by ethnicity
ethnicity_2024 <- attendance_data %>%
  filter(year == 2024, question_type == "binary", 
         response_category == "Yes - in the past year") %>%
  select(response_category, white, ethnic_minority) %>%
  rename(White = white, `Ethnic Minority` = ethnic_minority)

# Reshape for plotting
ethnicity_plot_data <- ethnicity_2024 %>%
  pivot_longer(cols = c(White, `Ethnic Minority`), 
               names_to = "Ethnicity", values_to = "Percentage")
```

### 2024 Attendance by Ethnicity

The data for 2024 shows a notable difference in church attendance between White and Ethnic Minority respondents.

- **White**: `r sprintf("%.1f", ethnicity_2024$White)`% attended in the past year.
- **Ethnic Minority**: `r sprintf("%.1f", ethnicity_2024[['Ethnic Minority']])`% attended in the past year.

This disparity is visualized in the bar chart below.

```{r}
#| label: ethnicity-plot
#| fig-cap: "Church attendance in the past year by ethnicity (2024)"

ggplot(ethnicity_plot_data, aes(x = Ethnicity, y = Percentage, fill = Ethnicity)) +
  geom_col(alpha = 0.8, show.legend = FALSE) +
  geom_text(aes(label = sprintf("%.1f%%", Percentage)), vjust = -0.5, size = 4) +
  scale_fill_brewer(palette = "Set2") +
  labs(
    x = "Ethnicity",
    y = "Attended in Past Year (%)",
    title = "Church Attendance by Ethnicity in 2024"
  ) +
  theme_minimal(base_size = 12)
```

⚠️ **Note**: These figures suggest different attendance patterns between ethnic groups. Population composition changes could significantly affect overall attendance rates.

## Age-Stratified Analysis

```{r}
#| label: age-breakdown

# Weekly attendance for 2018
age_2018 <- attendance_data %>%
  filter(year == 2018, response_category == "At least once a week")

# Weekly attendance for 2024 (sum of categories)
age_2024 <- attendance_data %>%
  filter(
    year == 2024,
    question_type == "frequency",
    response_category %in% c("Daily/almost daily", "A few times a week", "About once a week")
  ) %>%
  group_by(year, question_type) %>%
  summarise(
    across(c(age_18_34, age_35_54, age_55plus), sum, na.rm = TRUE),
    .groups = 'drop'
  ) %>%
  mutate(response_category = "At least once a week") # Add this for consistency

# Combine and create age_comparison
age_comparison <- bind_rows(age_2018, age_2024) %>%
  select(year, age_18_34, age_35_54, age_55plus) %>%
  rename(
    Year = year,
    `18-34` = age_18_34,
    `35-54` = age_35_54,
    `55+` = age_55plus
  )
```

### 2018

- **18-34**: `r sprintf("%.1f", age_comparison[['18-34']][age_comparison$Year == 2018])`%
- **35-54**: `r sprintf("%.1f", age_comparison[['35-54']][age_comparison$Year == 2018])`%
- **55+**: `r sprintf("%.1f", age_comparison[['55+']][age_comparison$Year == 2018])`%

### 2024

- **18-34**: `r sprintf("%.1f", age_comparison[['18-34']][age_comparison$Year == 2024])`%
- **35-54**: `r sprintf("%.1f", age_comparison[['35-54']][age_comparison$Year == 2024])`%
- **55+**: `r sprintf("%.1f", age_comparison[['55+']][age_comparison$Year == 2024])`%

### Changes (2024 - 2018)

- **18-34**: `r sprintf("%+.1f", age_comparison[['18-34']][age_comparison$Year == 2024] - age_comparison[['18-34']][age_comparison$Year == 2018])` percentage points
- **35-54**: `r sprintf("%+.1f", age_comparison[['35-54']][age_comparison$Year == 2024] - age_comparison[['35-54']][age_comparison$Year == 2018])` percentage points
- **55+**: `r sprintf("%+.1f", age_comparison[['55+']][age_comparison$Year == 2024] - age_comparison[['55+']][age_comparison$Year == 2018])` percentage points

## Visualisation: Age-Stratified Changes

```{r}
#| label: age-visualisation
#| fig-cap: "Change in weekly attendance by age group: 2018 vs 2024"

# Calculate changes in a robust way
data_2018 <- age_comparison %>%
  filter(Year == 2018) %>%
  pivot_longer(cols = -Year, names_to = "Age_Group", values_to = "y2018") %>%
  select(-Year)

data_2024 <- age_comparison %>%
  filter(Year == 2024) %>%
  pivot_longer(cols = -Year, names_to = "Age_Group", values_to = "y2024") %>%
  select(-Year)

age_changes <- full_join(data_2018, data_2024, by = "Age_Group") %>%
  mutate(
    y2018 = ifelse(is.na(y2018), 0, y2018),
    y2024 = ifelse(is.na(y2024), 0, y2024),
    change = y2024 - y2018
  ) %>%
  mutate(
    Age_Group = factor(Age_Group, levels = c("18-34", "35-54", "55+")),
    change_color = ifelse(change > 0, "darkgreen", "darkred")
  )

# Plot the changes
ggplot(age_changes, aes(x = Age_Group, y = change, fill = change_color)) +
  geom_col(alpha = 0.8) +
  geom_text(aes(label = sprintf("%+.1f", .data$change)), vjust = -0.5) +
  scale_fill_identity() +
  labs(
    x = "Age Group",
    y = "Percentage Point Change",
    title = "Change in Weekly Church Attendance (2018 to 2024)",
    subtitle = "By age group"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```

## Full Frequency Distribution (2018 vs 2024)

While the age-stratified analysis focuses on weekly attendance, looking at the full distribution of attendance frequency provides a more complete picture of how response patterns have changed between the two surveys.

The plot below compares the percentage of respondents in each attendance category for both 2018 and 2024.

```{r}
#| label: frequency-comparison-data

frequency_data <- attendance_data %>%
  filter(
    (year == 2018) | (year == 2024 & question_type == "frequency")
  ) %>%
  filter(response_category != "At least once a week") %>%
  mutate(
    Year = factor(year),
    response_category = factor(response_category, levels = c(
      "Daily/almost daily", "A few times a week", "About once a week",
      "About once a fortnight", "About once a month", "A few times a year",
      "About once a year", "Never"
    ))
  )
```

```{r}
#| label: frequency-comparison-plot
#| fig-cap: "Comparison of attendance frequency distribution (2018 vs 2024)"

ggplot(frequency_data, aes(x = response_category, y = total_pct, fill = Year)) +
  geom_col(position = "dodge", alpha = 0.8) +
  scale_fill_manual(values = c("2018" = "steelblue", "2024" = "darkorange")) +
  labs(
    x = "Attendance Frequency",
    y = "Percentage (%)",
    title = "Attendance Frequency Distribution: 2018 vs 2024",
    subtitle = "Comparison of all response categories"
  ) +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1))
```

This visualization highlights that while weekly attendance appears to have increased, the proportion of people who "Never" attend has also increased. This contradictory finding is another red flag that suggests the survey data may not be directly comparable due to the methodological changes discussed previously.


## The Demographic Composition Problem

**Critical Issue**: The surveys do not appear to control for demographic composition changes.

### Major population changes 2018-2024

1. **Ukrainian refugees**: 217,000-255,000
   - Higher Orthodox Christian attendance rates
   - Different cultural patterns

2. **Hong Kong BN(O) visa holders**: >163,000
   - Different religious demographics
   - May have higher church attendance rates

3. **Other net migration**: Substantial

### ⚠️ PROBLEM

If the surveys are not weighted or standardised to account for these demographic shifts, any apparent change in attendance could simply reflect:

- More religious immigrants entering the population
- Different attendance patterns of new arrivals
- NOT a 'revival' among existing UK residents

This is a form of 'composition change' vs 'behaviour change' confound that must be addressed to make valid comparisons.

## Implications

Without demographic standardisation, we cannot determine whether:

1. Attendance genuinely increased among existing UK residents (revival)
2. Attendance increased due to immigration (composition effect)
3. A combination of both

**Recommendation**: Any claims about a "revival" should control for demographic composition changes through:
- Demographic weighting adjustments
- Stratified analysis by immigration status
- Age/ethnicity standardisation

Until such analyses are conducted, the demographic composition issue remains a critical red flag.
